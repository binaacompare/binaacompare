<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue Matériaux | BinaaCompare</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e67e22; --dark: #1a2b3c; --bg: #f4f7fa; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        nav { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-weight: 700; font-size: 1.4rem; color: var(--dark); text-decoration: none; }
        .logo span { color: var(--primary); }
        .nav-links { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
        .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; font-size: 0.9rem; }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 30px; }
        .product-card { background: white; border-radius: 15px; padding: 15px; border: 1px solid #e1e8ed; transition: 0.3s; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .product-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; }
        
        .badge { background: #fff4eb; color: var(--primary); font-size: 0.7rem; padding: 4px 10px; border-radius: 50px; font-weight: 700; text-transform: uppercase; }
        .vendor-name { font-size: 0.75rem; color: #7f8c8d; font-weight: 600; display: block; margin-top: 5px; }
        .vendor-name i { color: #27ae60; margin-right: 3px; }
        
        .price-tag { font-size: 1.2rem; font-weight: 700; color: var(--dark); }
        #loading { grid-column: 1/-1; text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">Binaa<span>Compare</span></a>
        <ul class="nav-links">
            <li><a href="index.html">Accueil</a></li>
            <li id="dynamicProfileLink" style="display: none;">
                <a href="#" id="profileAnchor" style="color: var(--primary); font-weight: 700;">
                    <i class="fa-solid fa-circle-user"></i> <span id="profileText">Mon Profil</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Matériaux au Maroc</h1>
            <div id="userGreeting" style="font-size: 0.9rem; color: #666;"></div>
        </header>

        <div id="productsGrid" class="products-grid">
            <div id="loading"><i class="fas fa-circle-notch fa-spin"></i> Chargement des offres...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6WrsIzfsCCHMZmBkPzLQK2csKveaxY4U",
            authDomain: "binaacompare-fa5e1.firebaseapp.com",
            projectId: "binaacompare-fa5e1",
            storageBucket: "binaacompare-fa5e1.firebasestorage.app",
            messagingSenderId: "667570543544",
            appId: "1:667570543544:web:652218ab5a773eb2154d4d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Cache pour éviter de re-télécharger le même vendeur plusieurs fois
        const vendorCache = {};

        async function getVendorName(vendorId) {
            if (!vendorId) return "Fournisseur Inconnu";
            if (vendorCache[vendorId]) return vendorCache[vendorId];

            try {
                const vDoc = await getDoc(doc(db, "users", vendorId));
                if (vDoc.exists()) {
                    const name = vDoc.data().companyName || vDoc.data().firstName || "Partenaire";
                    vendorCache[vendorId] = name;
                    return name;
                }
            } catch (e) { console.error(e); }
            return "Partenaire Binaa";
        }

        onAuthStateChanged(auth, async (user) => {
            const linkItem = document.getElementById('dynamicProfileLink');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    linkItem.style.display = "block";
                    document.getElementById('userGreeting').innerText = `Bonjour, ${userData.firstName}`;
                    document.getElementById('profileAnchor').href = userData.role === "vendor" ? "dachv.html" : "profil_client.html";
                    document.getElementById('profileText').innerText = userData.role === "vendor" ? "Dashboard Pro" : "Mon Espace";
                }
            }
        });

        async function loadProducts() {
            const grid = document.getElementById('productsGrid');
            try {
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                grid.innerHTML = "";

                if (snapshot.empty) {
                    grid.innerHTML = "<p>Aucun produit disponible.</p>";
                    return;
                }

                // Utilisation de Promise.all pour charger les vendeurs en parallèle
                const cardsHTML = await Promise.all(snapshot.docs.map(async (pDoc) => {
                    const p = pDoc.data();
                    const vendorName = await getVendorName(p.vendorId);
                    
                    return `
                        <div class="product-card">
                            <img src="${p.imageUrl || 'https://via.placeholder.com/300'}" class="product-img">
                            <div style="margin-top:12px;">
                                <span class="badge">${p.category}</span>
                                <h3 style="margin:8px 0 2px; font-size:1rem;">${p.name}</h3>
                                <span class="vendor-name"><i class="fa-solid fa-store"></i> ${vendorName}</span>
                                
                                <p style="font-size:0.8rem; color:#666; margin:8px 0 0 0;">
                                    <i class="fa-solid fa-location-dot"></i> ${p.city}
                                </p>
                                
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; border-top:1px solid #f8f9fa; padding-top:10px;">
                                    <span class="price-tag">${p.price} <small style="font-size:0.7rem;">DH/${p.unit}</small></span>
                                    <a href="datapro.html?id=${pDoc.id}" style="color:var(--primary); font-size:0.85rem; font-weight:700; text-decoration:none;">DÉTAILS</a>
                                </div>
                            </div>
                        </div>
                    `;
                }));

                grid.innerHTML = cardsHTML.join('');
            } catch (err) {
                grid.innerHTML = "<p>Erreur de chargement.</p>";
                console.error(err);
            }
        }

        loadProducts();
    </script>
</body>
</html>