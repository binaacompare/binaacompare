<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>binaacompare | Tableau de Bord Acheteur</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --primary: #e67e22; --primary-light: #ffebda;
            --dark: #0f172a; --secondary: #1e293b;
            --bg: #f4f7fe; --white: #ffffff;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--dark); overflow-x: hidden; }

        .app-container { display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; background: var(--secondary); color: white;
            padding: 30px 20px; position: fixed; height: 100vh; z-index: 1000;
            transition: var(--transition);
        }
        
        /* Mobile Toggle Button */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo { font-size: 1.6rem; font-weight: 800; color: white; text-decoration: none; display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .logo span { color: var(--primary); }
        .nav-link {
            display: flex; align-items: center; gap: 15px; padding: 14px 18px;
            color: #94a3b8; text-decoration: none; border-radius: 12px;
            margin-bottom: 8px; transition: var(--transition); font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--primary); box-shadow: 0 10px 20px rgba(230, 126, 34, 0.2); }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 280px; flex: 1; padding: 40px; width: calc(100% - 280px); transition: var(--transition); }

        .profile-bar {
            background: var(--white); padding: 20px 30px; border-radius: 20px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.02);
        }
        .user-meta { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; flex-shrink: 0; }
        .role-tag { font-size: 0.7rem; background: #e0f2fe; color: #0ea5e9; padding: 4px 10px; border-radius: 50px; font-weight: 700; }

        /* --- STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 25px; border-radius: 20px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .icon-box { width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }

        /* --- DATA SECTION --- */
        .data-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 30px; }
        .panel { background: var(--white); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); min-height: 400px; overflow: hidden; }
        
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 500px; }
        th { text-align: left; padding: 12px; color: #64748b; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; }
        td { padding: 15px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

        .status-badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 50px; font-weight: 700; text-transform: uppercase; white-space: nowrap; }

        /* --- FAVORITES --- */
        #favoritesList { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .fav-card { 
            display: flex; align-items: center; gap: 15px; padding: 12px; 
            border-radius: 15px; border: 1px solid #f1f5f9; text-decoration: none; 
            color: inherit; transition: var(--transition);
        }
        .fav-card:hover { transform: translateX(8px); background: #f8fafc; border-color: var(--primary); }
        .fav-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 450px; padding: 30px; border-radius: 28px; position: relative; }
        
        .btn-primary { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 1024px) {
            .sidebar { left: -280px; }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; padding-top: 80px; }
            .mobile-toggle { display: block; }
            .data-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 640px) {
            .profile-bar { flex-direction: column; align-items: flex-start; gap: 15px; }
            .stat-card { padding: 15px; }
            .panel { padding: 15px; }
            .logo { margin-bottom: 20px; }
        }
        
    </style>
</head>
<body>

<button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fa-solid fa-bars"></i>
</button>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <a href="index.html" class="logo"><i class="fa-solid fa-cube"></i> <span>binaacompare</span></a>
        <nav>
            <a href="dashboard.html" class="nav-link active"><i class="fa-solid fa-chart-pie"></i> <span>Dashboard</span></a>
            <a href="adddemand.html" class="nav-link"><i class="fa-solid fa-plus-circle"></i> <span>Nouvelle Demande</span></a>
            <a class="nav-link" onclick="openModal('editProfileModal')"><i class="fa-solid fa-user-pen"></i> <span>Mon Profil</span></a>
            <a class="nav-link" id="logoutBtn" style="color:#f87171; margin-top: 50px;"><i class="fa-solid fa-power-off"></i> <span>Déconnexion</span></a>
        </nav>
        <div class="panel">
    <div class="section-title">
        <i class="fa-solid fa-bell animate__animated animate__swing animate__infinite" style="color:#f1c40f"></i> 
        Alertes de Prix
    </div>
    <div id="notificationsList" class="fav-list" style="max-height: 300px; overflow-y: auto;">
        <p style="text-align:center; color:#94a3b8; font-size:0.8rem; padding:20px;">Aucune nouvelle alerte.</p>
    </div>
</div>
    </aside>

    <main class="main-content">
        <div class="profile-bar animate__animated animate__fadeIn">
            <div class="user-meta">
                <div class="avatar" id="avatarLetter">?</div>
                <div>
                    <h3 id="displayUserName" style="font-size: 1.1rem;">Chargement...</h3>
                    <span class="role-tag" id="displayRole">PATIENTEZ...</span>
                </div>
            </div>
            <div id="companyBadge" style="display:none">
                <span id="displayICE" style="font-size: 0.8rem; font-weight:700; color:var(--primary)"></span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon-box" style="background:var(--primary-light); color:var(--primary)"><i class="fa-solid fa-paper-plane"></i></div>
                <div>
                    <p style="color:#64748b; font-size:0.85rem">Mes Demandes</p>
                    <h2 id="countDemands">0</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon-box" style="background:#dcfce7; color:#10b981"><i class="fa-solid fa-heart"></i></div>
                <div>
                    <p style="color:#64748b; font-size:0.85rem">Mes Favoris</p>
                    <h2 id="countFavs">0</h2>
                </div>
            </div>
        </div>

        <div class="data-grid">
            <div class="panel">
                <h3 style="font-size: 1.1rem;"><i class="fa-solid fa-list-check" style="margin-right:10px; color:var(--primary)"></i> Mes Demandes</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Matériau</th>
                                <th>Ville</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th style="text-align:center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="demandBody">
                            <tr><td colspan="5" style="text-align:center; padding:40px;">Chargement des données...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <h3 style="font-size: 1.1rem;"><i class="fa-solid fa-star" style="margin-right:10px; color:var(--primary)"></i> Produits Favoris</h3>
                <div id="favoritesList">
                    <p style="color:#94a3b8; font-size:0.8rem; text-align:center; padding:40px;">Aucun favori enregistré.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal" id="editProfileModal">
    <div class="modal-content">
        <h2>Mon Profil</h2>
        <div id="profileDetails" style="margin: 20px 0; line-height: 2;"></div>
        <button class="btn-primary" onclick="closeModal('editProfileModal')">Fermer</button>
    </div>
</div>

<script>
    // Toggle Sidebar for Mobile
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        const icon = document.querySelector('.mobile-toggle i');
        if (document.getElementById('sidebar').classList.contains('open')) {
            icon.classList.replace('fa-bars', 'fa-xmark');
        } else {
            icon.classList.replace('fa-xmark', 'fa-bars');
        }
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6WrsIzfsCCHMZmBkPzLQK2csKveaxY4U",
        authDomain: "binaacompare-fa5e1.firebaseapp.com",
        projectId: "binaacompare-fa5e1",
        storageBucket: "binaacompare-fa5e1.firebasestorage.app",
        appId: "1:667570543544:web:652218ab5a773eb2154d4d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            updateUI(user);
            loadDashboardData(user.uid);
        } else {
            window.location.href = "inscri.html";
        }
    });

    async function updateUI(user) {
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            const name = data.type === 'entreprise' ? data.companyName : `${data.firstname} ${data.lastname}`;
            document.getElementById('displayUserName').innerText = name;
            document.getElementById('avatarLetter').innerText = name.charAt(0).toUpperCase();
            document.getElementById('displayRole').innerText = (data.type || 'CLIENT').toUpperCase();
            
            if(data.ice) {
                document.getElementById('companyBadge').style.display = 'block';
                document.getElementById('displayICE').innerText = "ICE: " + data.ice;
            }

            document.getElementById('profileDetails').innerHTML = `
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Type:</strong> ${data.type}</p>
                ${data.phone ? `<p><strong>Tel:</strong> ${data.phone}</p>` : ''}
            `;
        }
    }

    async function loadDashboardData(uid) {
        try {
            const qDemands = query(collection(db, "demandes"), where("buyerId", "==", uid));
            const snapDemands = await getDocs(qDemands);
            document.getElementById('countDemands').innerText = snapDemands.size;
            const body = document.getElementById('demandBody');

            if (snapDemands.empty) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#94a3b8">Aucune demande active.</td></tr>`;
            } else {
                body.innerHTML = snapDemands.docs.map(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id; 
                    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString('fr-FR') : 'Récemment';
                    const isClosed = d.status === 'closed';
                    const statusColor = isClosed ? '#f1f5f9' : '#dcfce7';
                    const textColor = isClosed ? '#475569' : '#166534';

                    return `
                        <tr>
                            <td><strong style="text-transform:capitalize">${d.title || 'Inconnu'}</strong></td>
                            <td>${d.city || 'Maroc'}</td>
                            <td>${date}</td>
                            <td><span class="status-badge" style="background:${statusColor}; color:${textColor}">${d.status || 'open'}</span></td>
                            <td>
                                <div style="display:flex; gap:12px; justify-content:center;">
                                    <button onclick="closeDemand('${id}')" ${isClosed ? 'disabled' : ''} 
                                            style="background:none; border:none; color:${isClosed ? '#cbd5e1' : '#e67e22'}; cursor:pointer; font-size:1.1rem;">
                                        <i class="fa-solid fa-circle-check"></i>
                                    </button>
                                    <button onclick="deleteDemand('${id}')" 
                                            style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:1.1rem;">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const qFavs = query(collection(db, "favorites"), where("userId", "==", uid));
            const snapFavs = await getDocs(qFavs);
            document.getElementById('countFavs').innerText = snapFavs.size;

            const favList = document.getElementById('favoritesList');
            if (!snapFavs.empty) {
                favList.innerHTML = "";
                for (const fDoc of snapFavs.docs) {
                    const pId = fDoc.data().productId;
                    const pSnap = await getDoc(doc(db, "products", pId));
                    if (pSnap.exists()) {
                        const p = pSnap.data();
                        favList.innerHTML += `
                            <a href="datapro.html?id=${pId}" class="fav-card">
                                <img src="${p.imageUrl || 'https://via.placeholder.com/50'}" class="fav-img">
                                <div>
                                    <p style="font-weight:700; font-size:0.9rem">${p.name}</p>
                                    <p style="color:var(--primary); font-size:0.8rem">${p.price} DH</p>
                                </div>
                            </a>
                        `;
                    }
                }
            }
        } catch (e) { console.error("Erreur Dashboard:", e); }
    }

    window.closeDemand = async (id) => {
        if(confirm("Voulez-vous clôturer cette demande ?")) {
            await updateDoc(doc(db, "demandes", id), { status: "closed" });
            location.reload();
        }
    };

    window.deleteDemand = async (id) => {
        if(confirm("Supprimer définitivement cette demande ?")) {
            await deleteDoc(doc(db, "demandes", id));
            location.reload();
        }
    };

    window.openModal = (id) => document.getElementById(id).classList.add('active');
    window.closeModal = (id) => document.getElementById(id).classList.remove('active');
    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "index.html");
    // --- FONCTION NOTIFICATIONS EN TEMPS RÉEL ---
async function listenToPriceChanges(uid) {
    const notifContainer = document.getElementById('notificationsList');
    
    // 1. Récupérer la liste des IDs de produits favoris de l'utilisateur
    const qFavs = query(collection(db, "favorites"), where("userId", "==", uid));
    const favSnap = await getDocs(qFavs);
    
    if (favSnap.empty) return;

    const favoriteProductIds = favSnap.docs.map(doc => doc.data().productId);

    // 2. Écouter les notifications spécifiques à cet utilisateur
    // Note: Vous devez avoir une fonction côté vendeur qui écrit dans la collection "notifications"
    const qNotifs = query(
        collection(db, "notifications"), 
        where("userId", "==", uid),
        orderBy("createdAt", "desc"),
        limit(5)
    );

    // Utilisation de onSnapshot pour le temps réel sans recharger la page
    onSnapshot(qNotifs, (snapshot) => {
        if (snapshot.empty) return;
        
        notifContainer.innerHTML = "";
        snapshot.forEach((doc) => {
            const n = doc.data();
            const date = n.createdAt?.toDate() ? n.createdAt.toDate().toLocaleTimeString() : "Maintenant";
            
            const item = document.createElement('div');
            item.className = "fav-item"; // On réutilise le style existant
            item.style.borderLeft = "4px solid #f1c40f";
            item.innerHTML = `
                <div class="fav-info">
                    <h4 style="font-size:0.85rem;">${n.message}</h4>
                    <p style="font-size:0.7rem; color:#94a3b8;">${date} • <a href="datapro.html?id=${n.productId}" style="color:var(--primary)">Voir le nouveau prix</a></p>
                </div>
            `;
            notifContainer.appendChild(item);
        });
    });
}

// Appelez la fonction dans votre onAuthStateChanged
onAuthStateChanged(auth, (user) => {
    if (user) {
        // ... vos fonctions précédentes ...
        listenToPriceChanges(user.uid); 
    }
});

</script>
</body>
</html>