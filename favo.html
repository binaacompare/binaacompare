<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>March√© √âlite | BinaaCompare Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #e67e22;
            --primary-light: #ff9f43;
            --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.9);
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f2f5;
            margin: 0;
            overflow-x: hidden;
            color: var(--dark);
        }

        /* --- ANIMATION D'ARRI√àRE-PLAN --- */
        .bg-animate {
            position: fixed; inset: 0; z-index: -1; background: var(--bg-gradient);
            display: none; /* Activ√© seulement sur l'overlay */
        }

        .floating-icon {
            position: absolute; color: rgba(230, 126, 34, 0.2);
            animation: move linear infinite; pointer-events: none;
        }

        @keyframes move {
            from { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            to { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* --- OVERLAY DE S√âCURIT√â MODERNE --- */
        #auth-overlay {
            position: fixed; inset: 0; background: var(--bg-gradient); z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .access-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            padding: 40px;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            color: white;
        }

        .access-card i.main-lock {
            font-size: 4rem; color: var(--primary); margin-bottom: 20px;
            filter: drop-shadow(0 0 15px rgba(230, 126, 34, 0.4));
        }

        .instruction-badge {
            background: rgba(230, 126, 34, 0.1);
            color: var(--primary-light);
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 800;
            display: inline-block;
            margin-bottom: 15px;
        }

        .btn-access {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            background: var(--primary); color: white; text-decoration: none;
            padding: 18px; border-radius: 20px; font-weight: 700; margin-top: 25px;
            transition: 0.4s; border: none; cursor: pointer;
        }

        .btn-access:hover { transform: translateY(-5px); background: var(--primary-light); }

        /* --- NAVBAR & FILTRES --- */
        .navbar {
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 15px 5%; display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .search-container { position: relative; width: 40%; }
        .search-container input {
            width: 100%; padding: 12px 20px; border-radius: 15px;
            border: 1px solid #ddd; outline: none;
        }

        /* --- GRILLE D'OFFRES --- */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; display: none; }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

        .offer-card {
            background: white; border-radius: 32px; padding: 24px;
            border: 1px solid #e2e8f0; transition: 0.4s;
            display: flex; flex-direction: column;
        }
        .offer-card:hover { transform: translateY(-10px); border-color: var(--primary); }

        .btn-action {
            margin-top: auto; padding: 16px; background: var(--dark);
            color: white; border: none; border-radius: 18px; font-weight: 700;
            cursor: pointer; transition: 0.3s;
        }
    </style>
</head>
<body>

    <div id="bg-canvas" class="bg-animate"></div>
    
    <div id="auth-overlay">
        <div id="loader">
            <i class="fas fa-hammer fa-spin fa-3x" style="color:var(--primary)"></i>
            <h2 style="color:white; margin-top:20px;">V√©rification...</h2>
        </div>

        <div id="denied-msg" class="access-card" style="display:none;">
            <div class="instruction-badge">ACC√àS PROFESSIONNEL</div>
            <i class="fas fa-user-shield main-lock"></i>
            <h2>Zone R√©serv√©e aux Vendeurs</h2>
            <p style="color:#94a3b8; line-height:1.6;">Cette plateforme regroupe des appels d'offres strat√©giques. L'acc√®s est strictement r√©serv√© aux comptes <b>Vendeur certifi√©s</b>.</p>
            
            <div style="text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin: 20px 0;">
                <p style="margin:0; font-size: 0.9rem;"><i class="fas fa-info-circle" style="color:var(--primary)"></i> <b>Vendeur :</b> Connectez-vous pour r√©pondre.</p>
                <p style="margin:10px 0 0; font-size: 0.9rem;"><i class="fas fa-plus-circle" style="color:var(--primary)"></i> <b>Acheteur :</b> Publiez vos besoins via votre menu.</p>
            </div>

            <a href="cnx cendeur.html" class="btn-access">
                <i class="fas fa-sign-in-alt"></i> Acc√©der au March√© Pro
            </a>
            
            <a href="index.html" style="display:block; margin-top:20px; color:#64748b; text-decoration:none; font-size:0.9rem;">
                <i class="fas fa-arrow-left"></i> Retour √† l'accueil
            </a>
        </div>
    </div>

    <nav class="navbar">
        <a href="index.html" style="text-decoration:none; color:var(--dark); font-weight:800;">offres <span style="color:var(--primary)">Pro</span></a>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Filtrer par ville ou produit..." onkeyup="filterOffers()">
        </div>

        <a href="cnx cendeur.html" style="color:var(--dark); font-weight:700; text-decoration:none;">Connexion</a>
    </nav>

    <div class="container" id="main-content">
        <div style="margin-bottom:30px;">
            <h1 style="font-size: 2.2rem; margin:0;">Opportunit√©s de Chantiers üöÄ</h1>
            <p style="color:#64748b;">Consultez les demandes r√©elles et envoyez vos devis en un clic.</p>
        </div>
        <div id="market-grid" class="market-grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6WrsIzfsCCHMZmBkPzLQK2csKveaxY4U",
            authDomain: "binaacompare-fa5e1.firebaseapp.com",
            projectId: "binaacompare-fa5e1",
            storageBucket: "binaacompare-fa5e1.firebasestorage.app",
            appId: "1:667570543544:web:652218ab5a773eb2154d4d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let vendorData = null;

        // Animation d'arri√®re-plan
        function createBgAnimation() {
            const icons = ['fa-helmet-safety', 'fa-truck-pickup', 'fa-trowel-bricks', 'fa-tools'];
            const container = document.getElementById('bg-canvas');
            container.style.display = 'block';
            for(let i=0; i<15; i++) {
                const icon = document.createElement('i');
                icon.className = `fas ${icons[Math.floor(Math.random()*icons.length)]} floating-icon`;
                icon.style.left = Math.random() * 100 + 'vw';
                icon.style.fontSize = Math.random() * 30 + 20 + 'px';
                icon.style.animationDuration = Math.random() * 10 + 10 + 's';
                icon.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(icon);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const overlay = document.getElementById('auth-overlay');
            const loader = document.getElementById('loader');
            const denied = document.getElementById('denied-msg');

            if (user) {
                const userSnap = await getDoc(doc(db, "users", user.uid));
                if (userSnap.exists() && userSnap.data().role === "vendor") {
                    vendorData = userSnap.data();
                    overlay.style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    loadOffers();
                } else {
                    loader.style.display = 'none';
                    denied.style.display = 'block';
                    createBgAnimation();
                }
            } else {
                loader.style.display = 'none';
                denied.style.display = 'block';
                createBgAnimation();
            }
        });

        async function loadOffers() {
            const grid = document.getElementById('market-grid');
            const q = query(collection(db, "demandes"), where("status", "==", "open"));
            const snap = await getDocs(q);
            grid.innerHTML = "";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const card = document.createElement('div');
                card.className = 'offer-card';
                card.innerHTML = `
                    <span style="background:#dcfce7; color:#166534; padding:5px 12px; border-radius:50px; font-size:0.7rem; font-weight:800; align-self:start;">ACHETEUR V√âRIFI√â</span>
                    <h2 style="font-size:1.4rem; margin:15px 0 10px;">${d.title}</h2>
                    <div style="color:#64748b; font-size:0.9rem; margin-bottom:15px;"><i class="fas fa-map-marker-alt"></i> ${d.city}</div>
                    <div style="background:#f8fafc; padding:15px; border-radius:18px; font-size:0.9rem; margin-bottom:15px; border-left:4px solid var(--primary);">${d.description}</div>
                    <button class="btn-action" onclick="sendProfessionalEmail('${d.buyerEmail}', '${d.title}', '${d.city}', '${d.buyerName || 'Acheteur'}')">
                        <i class="fas fa-paper-plane"></i> R√©pondre au client
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        window.filterOffers = () => {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.getElementsByClassName('offer-card');
            for (let card of cards) {
                card.style.display = card.innerText.toLowerCase().includes(input) ? "flex" : "none";
            }
        };

        window.sendProfessionalEmail = (buyerEmail, jobTitle, city, buyerName) => {
    // R√©cup√©ration s√©curis√©e du nom de l'entreprise ou du nom propre
    const vName = vendorData.companyName || `${vendorData.firstname} ${vendorData.lastname}`;
    const vPhone = vendorData.phone || "Non renseign√©";
    const vEmail = auth.currentUser.email; // Email du vendeur actuellement connect√©

    // Construction d'un objet percutant
    const subject = encodeURIComponent(`PROPOSITION COMMERCIALE - ${jobTitle.toUpperCase()} (${city})`);

    // Corps du message structur√© professionnellement
    const body = encodeURIComponent(
        `Bonjour ${buyerName},\n\n` +
        `Suite √† votre demande publi√©e sur BinaaCompare concernant : "${jobTitle}" √† ${city}, ` +
        `notre entreprise ${vName} a le plaisir de vous soumettre son int√©r√™t.\n\n` +
        `--- D√âTAILS DE NOTRE INTERVENTION ---\n` +
        `‚Ä¢ Service : ${jobTitle}\n` +
        `‚Ä¢ Localisation : ${city}\n` +
        `‚Ä¢ Statut : Partenaire certifi√© BinaaCompare\n\n` +
        `Nous sommes disponibles pour discuter des d√©tails techniques et vous √©tablir un devis personnalis√© adapt√© √† votre budget.\n\n` +
        `--- NOS COORDONN√âES DIRECTES ---\n` +
        `üìû T√©l√©phone : ${vPhone}\n` +
        `üìß Email : ${vEmail}\n\n` +
        `Dans l'attente de votre retour pour fixer un rendez-vous ou un appel.\n\n` +
        `Cordialement,\n` +
        `L'√©quipe ${vName}`
    );

    // D√©clenchement de l'envoi
    window.location.href = `mailto:${buyerEmail}?subject=${subject}&body=${body}`;
};
    </script>
</body>
</html>