<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Produit | BinaaCompare</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --orange: #e67e22; --blue: #1a2b3c; --bg: #f8fafc; --white: #ffffff; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; color: #2d3436; }
        
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }

        /* Bouton Retour */
        .btn-back-catalog {
            display: inline-flex; align-items: center; gap: 10px; background: var(--white);
            color: var(--blue); padding: 12px 20px; border-radius: 12px;
            text-decoration: none; font-weight: 600; font-size: 0.9rem;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: 0.3s ease; border: 1px solid #eee;
        }
        .btn-back-catalog:hover { background: var(--orange); color: white; transform: translateX(-5px); border-color: var(--orange); }

        /* Carte Produit */
        .product-card { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 40px; 
            background: var(--white); padding: 35px; border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .image-side img { width: 100%; border-radius: 20px; height: 450px; object-fit: cover; }
        .badge { background: #fff3e0; color: var(--orange); padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; }
        .price { font-size: 2.2rem; color: #27ae60; font-weight: 800; margin: 15px 0; }
        
        .details-list { margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px; }
        .details-list p { margin: 8px 0; font-size: 0.95rem; }
        .details-list i { color: var(--orange); width: 25px; }

        /* Boutons d'action */
        .btn { padding: 15px; border-radius: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; transition: 0.3s; margin-top: 10px; border:none; cursor:pointer; }
        .btn-call { background: #2ecc71; color: white; }
        .btn-email { background: var(--blue); color: white; }

        /* Notification de Connexion */
        .login-notice {
            background: #fff9f0; border: 1px dashed var(--orange);
            padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px;
        }
        .btn-login-redirect {
            background: var(--blue); color: white; padding: 10px 20px; border-radius: 50px;
            text-decoration: none; font-weight: 700; display: inline-flex; align-items: center;
            gap: 8px; margin-top: 10px; font-size: 0.9rem;
        }

        /* Avis Section */
        .reviews-section { margin-top: 50px; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .review-item { padding: 15px 0; border-bottom: 1px solid #eee; }
        .review-form { background: #f9f9f9; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .stars-input i { font-size: 1.5rem; color: #ddd; cursor: pointer; }
        .stars-input i.active { color: #f1c40f; }
        textarea { width: 100%; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; font-family: inherit; }

        #loader { text-align: center; padding: 100px; }
        @media (max-width: 768px) { .product-card { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

    <div class="container" id="mainContent" style="display: none;">
        
        <a href="index.html" class="btn-back-catalog">
            <i class="fas fa-th-large"></i> Retour au catalogue
        </a>

        <div class="product-card">
            <div class="image-side"><img id="productImg" src=""></div>
            <div class="info-side">
                <span class="badge" id="productCat">---</span>
                <h1 id="productName" style="color:var(--blue); margin:10px 0;">---</h1>
                <div class="price"><span id="productPrice">0</span> DH</div>

                <div class="details-list">
                    <p><i class="fas fa-map-marker-alt"></i> Ville: <b id="productCity">--</b></p>
                    <p><i class="fas fa-boxes"></i> Stock: <b id="productStock">--</b></p>
                    <p><i class="fas fa-ruler-combined"></i> Unité: <b id="productUnit">--</b></p>
                    <p><i class="fas fa-building"></i> Vendeur: <b id="vendorName">--</b></p>
                </div>

                <p id="productDesc" style="color:#636e72; font-size:0.9rem;">--</p>

                <div id="buyerActions" style="display: none; margin-top: 20px;">
                    <a href="#" id="callBtn" class="btn btn-call"><i class="fas fa-phone-alt"></i> Appeler le vendeur</a>
                    <a href="#" id="emailBtn" class="btn btn-email"><i class="fas fa-envelope"></i> Demander l'achat</a>
                </div>

                <div id="guestNotice" class="login-notice">
                    <i class="fas fa-lock" style="color:var(--orange)"></i>
                    <p style="margin:5px 0; font-size:0.9rem;">Connectez-vous pour voir les contacts du vendeur.</p>
                    <a href="conx.html" class="btn-login-redirect"><i class="fas fa-user"></i> Se connecter</a>
                </div>
            </div>
        </div>

        <div class="reviews-section">
            <h3><i class="fas fa-star" style="color:var(--orange)"></i> Avis sur ce produit</h3>
            <div id="listReviews"></div>
            
            <div id="reviewFormContainer" style="display: none;" class="review-form">
                <h4>Laisser un avis</h4>
                <div class="stars-input" id="starsInput">
                    <i class="fas fa-star" data-v="1"></i><i class="fas fa-star" data-v="2"></i><i class="fas fa-star" data-v="3"></i><i class="fas fa-star" data-v="4"></i><i class="fas fa-star" data-v="5"></i>
                </div>
                <textarea id="reviewText" rows="3" placeholder="Votre avis sur ce produit..."></textarea>
                <button id="submitReview" class="btn btn-email" style="width:100%">Publier l'avis</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6WrsIzfsCCHMZmBkPzLQK2csKveaxY4U",
            authDomain: "binaacompare-fa5e1.firebaseapp.com",
            projectId: "binaacompare-fa5e1",
            storageBucket: "binaacompare-fa5e1.firebasestorage.app",
            appId: "1:667570543544:web:652218ab5a773eb2154d4d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const prodId = new URLSearchParams(window.location.search).get('id');

        let currentBuyer = null;
        let selectedRating = 0;

        onAuthStateChanged(auth, async (user) => {
            const actions = document.getElementById('buyerActions');
            const notice = document.getElementById('guestNotice');
            const reviewForm = document.getElementById('reviewFormContainer');

            if (user) {
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists() && uDoc.data().role === "buyer") {
                    currentBuyer = { id: user.uid, ...uDoc.data() };
                    actions.style.display = "block";
                    reviewForm.style.display = "block";
                    notice.style.display = "none";
                }
            } else {
                actions.style.display = "none";
                reviewForm.style.display = "none";
                notice.style.display = "block";
            }
            loadProduct();
            loadReviews();
        });

        // Logique des étoiles (inchangée)
        document.querySelectorAll('#starsInput i').forEach(s => {
            s.onclick = () => {
                selectedRating = s.dataset.v;
                document.querySelectorAll('#starsInput i').forEach(i => i.classList.toggle('active', i.dataset.v <= selectedRating));
            }
        });

        async function loadProduct() {
            if (!prodId) return;
            const pSnap = await getDoc(doc(db, "products", prodId));
            if (pSnap.exists()) {
                const p = pSnap.data();
                document.getElementById('productName').innerText = p.name;
                document.getElementById('productPrice').innerText = p.price;
                document.getElementById('productCat').innerText = p.category;
                document.getElementById('productCity').innerText = p.city;
                document.getElementById('productStock').innerText = p.stock || 0;
                document.getElementById('productUnit').innerText = p.unit;
                document.getElementById('productDesc').innerText = p.description || "";
                document.getElementById('productImg').src = p.imageUrl;

                const vSnap = await getDoc(doc(db, "users", p.vendorId));
                if (vSnap.exists()) {
                    const v = vSnap.data();
                    document.getElementById('vendorName').innerText = v.companyName || "Fournisseur";
                    
                    if (currentBuyer) {
    // Lien d'appel direct
    document.getElementById('callBtn').href = `tel:${v.phone}`;

    // Récupération de l'URL actuelle du produit
    const productUrl = window.location.href;

    // Construction d'un e-mail professionnel et structuré
    const subject = encodeURIComponent(`[BinaaCompare] Demande d'achat - ${p.name}`);
    
    const mailBody = encodeURIComponent(
        `Bonjour ${v.companyName || 'le fournisseur'},\n\n` +
        `Je vous contacte via la plateforme BinaaCompare car je suis très intéressé par l'article suivant :\n\n` +
        `-------------------------------------------\n` +
        `DÉTAILS DU PRODUIT :\n` +
        `- Nom : ${p.name}\n` +
        `- Prix : ${p.price} DH\n` +
        `- Ville : ${p.city}\n` +
        `- Lien direct : ${productUrl}\n` + // <--- LIEN DU PRODUIT AJOUTÉ ICI
        `-------------------------------------------\n\n` +
        `COORDONNÉES DE L'ACHETEUR :\n` +
        `- Nom : ${currentBuyer.firstName} ${currentBuyer.lastName}\n` +
        `- Téléphone : ${currentBuyer.phone || 'Non renseigné'}\n\n` +
        `Pourriez-vous me confirmer la disponibilité du stock pour ce produit ?\n\n` +
        `Dans l'attente de votre retour.\n\n` +
        `Cordialement,\n` +
        `${currentBuyer.firstName} ${currentBuyer.lastName}\n\n` +
        `Message généré par BinaaCompare.ma`
    );

    document.getElementById('emailBtn').href = `mailto:${v.email}?subject=${subject}&body=${mailBody}`;
}
                }
                document.getElementById('loader').style.display = "none";
                document.getElementById('mainContent').style.display = "block";
            }
        }

        async function loadReviews() {
            const q = query(collection(db, "product_reviews"), where("productId", "==", prodId));
            const snap = await getDocs(q);
            const list = document.getElementById('listReviews');
            list.innerHTML = snap.empty ? "<p>Aucun avis pour ce produit.</p>" : "";
            snap.forEach(d => {
                const r = d.data();
                list.innerHTML += `<div class="review-item">
                    <strong>${r.buyerName}</strong> <span style="color:#f1c40f;">${'★'.repeat(r.rating)}</span>
                    <p style="margin:5px 0; color:#666;">${r.comment}</p>
                </div>`;
            });
        }

        document.getElementById('submitReview').onclick = async () => {
            const comment = document.getElementById('reviewText').value;
            if (selectedRating === 0 || comment.length < 3) return alert("Notez et commentez le produit.");
            await addDoc(collection(db, "product_reviews"), {
                productId: prodId,
                buyerId: currentBuyer.id,
                buyerName: currentBuyer.firstName + " " + currentBuyer.lastName,
                rating: parseInt(selectedRating),
                comment: comment,
                createdAt: serverTimestamp()
            });
            location.reload();
        };
    </script>
</body>
</html>